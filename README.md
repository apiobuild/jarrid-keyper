# jarrid-keyper

Keyper is a suite of key manage APIs to simplify key creation, management, encryption/decryption in standardized
and secured way. Operations are file based and can be easily automated, tracked, audited and managed via file based
processes such as [GitOps](https://github.com/topics/gitops).

The library has three main modules:

1. [Key Module](#key-module): Create key configs as json file, helps you manage different key implementations
   in a simple, trackable and readable ways. Encrypt and decrypt data using key configs.
2. [Deploy Module](#deploy-module): Take the existing key configs (in json files), plan and deploy
   via [terraform](https://www.terraform.io/) accordingly. It
   takes advantage of terraform's existing functionalities such as state management, dependency resolution, drift
   tracking
   without losing the flexibility to modularize deployment as granular as needed.

## Key Module

Key module generates key configs in json based on usage specified. Currently, the library supports using local disk as
file
backend. In the future, we plan to support remote storage such as [GitHub](https://github.com/) and cloud storage such
as [s3](https://aws.amazon.com/s3/)
and [GCS](https://cloud.google.com/storage).

### Key Management

Create a key config for data encryption

Example:

```bash
keyper key create --backend LOCAL --stack GCP # create key
keyper key list # list keys
```

### Encrypt/Decrypt

```bash
keyper data encrypt --backend LOCAL --stack GCP --key-id "<key-id>" --plaintext "<>"
# should return: Encrypted value: <...>

```

## Deploy Module

Deploy module implements [Terraform Cloud Development Kit](https://developer.hashicorp.com/terraform/cdktf) underneath.
It scans existing key configs generated by [key module](#key-module) and programatically construct terraform provider,
modules and
resources accordingly.

### Plan

This wraps [`cdktf synth`](https://developer.hashicorp.com/terraform/cdktf/cli-reference/commands#synth)
and [`cdktf diff`](https://developer.hashicorp.com/terraform/cdktf/cli-reference/commands#diff) command
underneath. It's the equivalent of [`terraform plan`](https://developer.hashicorp.com/terraform/cli/commands/plan)
in [cdktf]((https://developer.hashicorp.com/terraform/cdktf))

```bash
keyper deploy plan --usage CREATE_KEY --backend LOCAL --stack GCP
```

### Apply

This wraps [`cdktf deploy`](https://developer.hashicorp.com/terraform/cdktf/cli-reference/commands#deploy) command
underneath. It's the equivalent of [`terraform apply`](https://developer.hashicorp.com/terraform/cli/commands/apply)
in [cdktf]((https://developer.hashicorp.com/terraform/cdktf))

```bash
keyper deploy applydocke
```

## Development

### Compile Cli Jar

```bash
# build jar
./gradlew build 

# give permission to run the jar
chmod +x ./lib/build/libs/lib-standalone.jar

# use jar as keyper cli
 java -jar ./lib/build/libs/lib-standalone.jar key -h
 
# wrap it into keyper
alias keyper="java -jar ./lib/build/libs/lib-standalone.jar"

# try
keyper -h
```

### Docker

We've also built a docker image where we've packaged everything you need for you and you can use it as a cli directly.

If you'd like to build and test it out locally:

```bash
docker build . -t keyper
```

Otherwise, to run cli commands:

```bash
docker pull ghcr.io/apiobuild/keyper
```

Note, if you get permission denied, try to log out from ghcr.io first:

```bash
docker logout ghcr.io
```

Run the packaged cli directly from docker:

```bash
# create key
docker run -it --rm --name keyper-cli \
  -v ./configs:/home/keyper/configs \
  -v ./cdktf.out:/home/keyper/cdktf.out \
  ghcr.io/apiobuild/keyper:main key create --backend LOCAL --stack GCP 

# run plan
docker run -it --rm --name keyper-cli \
  -v ./configs:/home/keyper/configs \
  -v ./cdktf.out:/home/keyper/cdktf.out \
  -v ./.cdktf-sa-key.json:/home/keyper/gcp.json \
  -e GOOGLE_APPLICATION_CREDENTIALS="/home/keyper/gcp.json" \
  ghcr.io/apiobuild/keyper:main deploy plan
```

## Deployment

### GCP

Set gcp provider configuration in `lib/src/main/resources/app.yaml`

1. Create Service Account for Terraform
   ```bash
   SERVICE=keyper
   PROJECT_ID=$(gcloud config get-value project)
   gcloud iam service-accounts create $SERVICE-cdktf-sa
   ```
2. Add `roles/cloudkms.admin` to the sa
   ```bash
   SERVICE=keyper
   PROJECT_ID=$(gcloud config get-value project)
   gcloud projects add-iam-policy-binding $PROJECT_ID \
   --member "serviceAccount:$SERVICE-cdktf-sa@$PROJECT_ID.iam.gserviceaccount.com" \
   --role "roles/cloudkms.admin"
   ```
   You can also verify it by running:
   ```bash
   gcloud projects get-iam-policy $PROJECT_ID \
    --flatten="bindings[].members" \
    --filter="bindings.members:serviceAccount:$SERVICE-cdktf-sa@$PROJECT_ID.iam.gserviceaccount.com"
   ```
3. Create and download the key

   **Make sure you don't commit `.cdktf-sa-key.json` to github.**
   ```bash
   gcloud iam service-accounts keys create .cdktf-sa-key.json \
    --iam-account "$SERVICE-cdktf-sa@$PROJECT_ID.iam.gserviceaccount.com"
   ```

4. Set ENV `GOOGLE_APPLICATION_CREDENTIALS` to path

That's it. Enjoy.